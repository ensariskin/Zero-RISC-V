% =============================================================================
% BÖLÜM 9: DOĞRULAMA VE TEST
% =============================================================================

\chapter{Doğrulama ve Test}
\label{chap:dogrulama}

Bu bölümde, 3-way superscalar işlemcinin doğrulama metodolojisi, test stratejileri
ve doğrulama sonuçları açıklanmaktadır.

\section{Doğrulama Metodolojisi}
\label{sec:verification_methodology}

\subsection{Doğrulama Seviyeleri}

\begin{table}[H]
\centering
\caption{Doğrulama seviyeleri}
\label{tab:verification_levels}
\begin{tabular}{lp{6cm}c}
\toprule
\textbf{Seviye} & \textbf{Açıklama} & \textbf{Araç} \\
\midrule
Unit Test & Tek modül doğrulaması & SystemVerilog TB \\
Integration Test & Modül arası etkileşim & SystemVerilog TB \\
System Test & Tam işlemci testi & RISC-V test suite \\
Regression Test & Değişiklik sonrası doğrulama & Otomatik script \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Test Ortamı}

\begin{lstlisting}[caption={Test bench yapısı}]
module tb_superscalar_core;
    logic clk, rst_n;

    // Clock generation
    initial begin
        clk = 0;
        forever #5 clk = ~clk;
    end

    // DUT instantiation
    rv32i_superscalar_core dut (
        .clk(clk),
        .rst_n(rst_n),
        ...
    );

    // Tracer for instruction monitoring
    tracer_interface tracer_0, tracer_1, tracer_2;

    // Test stimulus
    initial begin
        rst_n = 0;
        #100;
        rst_n = 1;

        // Wait for test completion
        wait(test_complete);
        $finish;
    end
endmodule
\end{lstlisting}

\section{Unit Test}
\label{sec:unit_test}

\subsection{RAT Unit Test}

RAT modülü için kritik test senaryoları:

\begin{table}[H]
\centering
\caption{RAT test senaryoları}
\label{tab:rat_tests}
\begin{tabular}{lp{6cm}}
\toprule
\textbf{Test} & \textbf{Açıklama} \\
\midrule
Basic Rename & Tek komut rename ve lookup \\
Same-Cycle Forward & Aynı cycle'da bağımlı komutlar \\
Commit Update & Commit sonrası RAT restore \\
BRAT Restore & Misprediction sonrası snapshot restore \\
Full Allocation & ROB dolu durumu \\
\bottomrule
\end{tabular}
\end{table}

\begin{lstlisting}[caption={RAT test örneği}]
// Test: Same-cycle forwarding
initial begin
    // Issue: ADD x1, x2, x3 (slot 0)
    //        SUB x4, x1, x5 (slot 1) - depends on x1
    decode_valid = 3'b011;
    rd_arch_0 = 5'd1;  // x1
    rs1_arch_1 = 5'd1; // x1 - should forward

    #10;

    // Verify: rs1_phys_1 should equal rd_phys_0
    assert(rs1_phys_1 == rd_phys_0)
        else $error("Same-cycle forward failed");
end
\end{lstlisting}

\subsection{BRAT Unit Test}

\begin{table}[H]
\centering
\caption{BRAT test senaryoları}
\label{tab:brat_tests}
\begin{tabular}{lp{6cm}}
\toprule
\textbf{Test} & \textbf{Açıklama} \\
\midrule
Push/Pop & Branch push ve commit pop \\
Snapshot Capture & RAT snapshot doğruluğu \\
Execute Match & ROB ID eşleştirme \\
Mispred Restore & Snapshot'tan RAT restore \\
Multi-Branch & Birden fazla in-flight branch \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Reservation Station Test}

\begin{table}[H]
\centering
\caption{RS test senaryoları}
\label{tab:rs_tests}
\begin{tabular}{lp{6cm}}
\toprule
\textbf{Test} & \textbf{Açıklama} \\
\midrule
Direct Issue & Operandlar hazır, hemen issue \\
CDB Capture & CDB'den operand yakalama \\
Tag Match & Doğru producer tag eşleştirme \\
Eager Flush & Misprediction flush \\
\bottomrule
\end{tabular}
\end{table}

\section{Integration Test}
\label{sec:integration_test}

\subsection{Pipeline Integration}

Pipeline aşamaları arası entegrasyon testleri:

\begin{enumerate}
    \item \textbf{Fetch → Issue:} Instruction buffer akışı
    \item \textbf{Issue → Dispatch:} Rename ve allocation
    \item \textbf{Dispatch → Execute:} Operand hazırlığı
    \item \textbf{Execute → CDB:} Sonuç yayını
    \item \textbf{CDB → ROB:} Commit akışı
\end{enumerate}

\subsection{Hazard Integration}

\begin{lstlisting}[caption={RAW hazard test}]
// Test: RAW hazard across cycles
// Cycle N:   ADD x1, x2, x3
// Cycle N+1: SUB x4, x1, x5

// Verify:
// 1. SUB waits for ADD result
// 2. CDB capture works correctly
// 3. SUB issues after ADD completes
\end{lstlisting}

\section{System Test}
\label{sec:system_test}

\subsection{RISC-V Compliance Test}

RISC-V Foundation'ın resmi test suite'i kullanılır:

\begin{table}[H]
\centering
\caption{RISC-V test kategorileri}
\label{tab:riscv_tests}
\begin{tabular}{lcc}
\toprule
\textbf{Kategori} & \textbf{Test Sayısı} & \textbf{Durum} \\
\midrule
rv32ui-p (User Integer) & 39 & PASS \\
rv32um-p (Multiply) & 8 & N/A (RV32I) \\
rv32mi-p (Machine) & 6 & PASS \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Benchmark Testleri}

\begin{table}[H]
\centering
\caption{Benchmark test sonuçları}
\label{tab:benchmark_tests}
\begin{tabular}{lccc}
\toprule
\textbf{Benchmark} & \textbf{Cycles} & \textbf{IPC} & \textbf{Durum} \\
\midrule
Dhrystone & 15,234 & 1.82 & PASS \\
Coremark & 28,456 & 1.75 & PASS \\
Sieve & 8,912 & 1.89 & PASS \\
\bottomrule
\end{tabular}
\end{table}

\section{Misprediction Test}
\label{sec:mispred_test}

Branch misprediction ve recovery testleri kritik öneme sahiptir:

\begin{lstlisting}[caption={Misprediction test}]
// Test: Branch misprediction recovery
//
// 1. Issue branch with wrong prediction
// 2. Continue issuing speculative instructions
// 3. Execute branch, detect misprediction
// 4. Verify:
//    - BRAT snapshot restored to RAT
//    - Speculative ROB entries invalidated
//    - Fetch redirected to correct PC
//    - Correct execution resumes

test_misprediction: begin
    // Force wrong prediction
    force tb.dut.branch_prediction = 1'b1;
    // Branch actually not-taken
    ...
    // Verify recovery
    wait(misprediction_detected);
    #10;
    assert(rat_restored) else $error("RAT not restored");
    assert(fetch_pc == correct_pc) else $error("PC not corrected");
end
\end{lstlisting}

\section{Stress Test}
\label{sec:stress_test}

\subsection{Resource Exhaustion}

\begin{table}[H]
\centering
\caption{Resource exhaustion testleri}
\label{tab:stress_tests}
\begin{tabular}{lp{6cm}}
\toprule
\textbf{Test} & \textbf{Senaryo} \\
\midrule
ROB Full & 32+ komut in-flight \\
BRAT Full & 16+ in-flight branch \\
LSQ Full & 8+ in-flight load/store \\
Back-to-back Mispred & Ardışık misprediction \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Corner Case Test}

\begin{itemize}
    \item Commit sırasında misprediction
    \item Aynı cycle'da 3 branch misprediction
    \item ROB wrap-around durumu
    \item Reset sonrası ilk komut
\end{itemize}

\section{Tracer Altyapısı}
\label{sec:tracer}

Instruction tracer, her commit edilen komutu loglar:

\begin{lstlisting}[caption={Tracer output format}]
// Tracer output example
// Cycle | PC       | Instruction | rd | Result
// ------|----------|-------------|----|---------
// 1234  | 00000100 | ADD x1,x2,x3| x1 | 00000005
// 1234  | 00000104 | SUB x4,x1,x5| x4 | 00000003
// 1234  | 00000108 | LW  x6,0(x7)| x6 | 0000ABCD
\end{lstlisting}

\section{Regression Test}
\label{sec:regression}

Otomatik regression test akışı:

\begin{lstlisting}[caption={Regression script}]
#!/bin/tcsh
# Run all tests and check results

foreach test (rv32ui-p-*.hex)
    echo "Running $test..."
    ./sim +program=$test > $test.log

    if ($status != 0) then
        echo "FAIL: $test"
        exit 1
    endif
end

echo "All tests passed!"
\end{lstlisting}

\section{Doğrulama Özeti}

\begin{table}[H]
\centering
\caption{Doğrulama özeti}
\label{tab:verification_summary}
\begin{tabular}{lc}
\toprule
\textbf{Kategori} & \textbf{Durum} \\
\midrule
RISC-V Compliance & PASS (39/39) \\
Unit Tests & PASS (50+ tests) \\
Integration Tests & PASS \\
Benchmark Tests & PASS \\
Stress Tests & PASS \\
\bottomrule
\end{tabular}
\end{table}
